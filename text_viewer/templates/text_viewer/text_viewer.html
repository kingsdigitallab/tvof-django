{% extends "base_minimal.html" %}
{% load staticfiles compress require cms_tags wagtailcore_tags %}

{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
        integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
        crossorigin=""/>
{% endblock %}

{% block title %}
Textviewer
{% endblock %}

{% block body_classes %}body-text-viewer{% endblock %}

{% block header_top_bar %}
    {# TODO: REMOVE top toolbar is no longer used. #}
    <ul class="horizontal menu float-right mini-header">
        {% comment %}
        <li>
            <a href=""><i class="fa fa-key"></i></a>
        </li>
        {% endcomment %}
        {% comment %}
        <li>
            <a href=""><i class="fa fa-random"></i></a>
        </li>
        {% endcomment %}
        {% comment %}
        <li>
            {# <a href=""><i class="fa fa-columns"></i></a> #}
    
            <a id="btn-open-panel" href="#" title="Open a new panel">
                <i class="fa fa-columns"></i>
            </a>
        </li>
        <li>
            <a href=""><i class="fa fa-expand"></i></a>
        </li>
        {% endcomment %}
    </ul>
{% endblock %}

{% block minimal_breadcrumb %}
    <small>/ Text Viewer</small>
{% endblock %}

{% block main_wrapper %}

{% verbatim %}
<!-- #text-viewer height is adjusted automatically with JS  -->
<section id="text-viewer" class="main text-viewer">
    <div id="text-viewer-glass"></div>
    <div v-for="pane in panes" is="text-pane" v-bind:apane="getPane(pane.slug)"></div>
</section>
{% endverbatim %}

{% comment %}

GN: the code below serves as a template for any number of text panes.
Apart from id="vue-template-text-pane", please do not use hardcoded id attribute
(they would be duplicated which is not allowed in HTML).

Some of the Foundation controls or special behaviour/plugins are managed with
a vue directive:
* v-f-dropdown: for a Foundation dropdown-menu
* v-f-sticky: for a sticky element

{% endcomment %}
{% verbatim %}
<div class="vue-templates">
    <div id="vue-template-text-pane" class="text-pane">
        <div class="row">
            <div class="small-12 columns">

                <a v-if="canClosePane()" href="#" v-on:click.stop.prevent="closePane()" class="close-panel-button float-right">
                    <i class="fa fa-trash" aria-label="Close this panel" title="Close this panel">
                    </i>
                </a>

                <div class="controls">
                    <ul v-f-dropdown class="boxed" data-disable-hover="true">
                        <li>
                            <a><h2 class="ms-title">{{ document.label }}</h2></a>
                            <ul>
                                <li v-for="adocument in documents" v-bind:class="{active: adocument.slug == document.slug, 'is-submenu-item': 1, 'is-dropdown-submenu-item': 1}">
                                    <a v-on:click.prevent="onClickDocument(adocument.slug)" href="#">{{ adocument.label }}</a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <ul v-f-dropdown class="boxed" data-disable-hover="true">
                        <li class="dropdown-views">
                            <a>{{ view.label }}</a>
                            <ul>
                                <li v-for="aview in views" v-bind:class="{active: aview.slug == view.slug, 'is-submenu-item': 1, 'is-dropdown-submenu-item': 1}">
                                    <a v-on:click.prevent="onClickView(aview.slug)" href="#">
                                        {{ aview.label }}
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row" v-bind:id="'section-menu-'+pane_slug">
            <div class="small-12 columns">
                <!-- No toggle button in Foundation???
                    Tried switch but too wide for side bar 
                -->
                <ul v-f-dropdown>
                    <li v-if="canBeSynced" v-bind:class="{active: is_synced, disabled: !canBeSynced}">
                        <a href="#" v-on:click.prevent="toggleSynced()" class="">
                            <i v-bind:class="'fa fa-chain'+(!is_synced ? '-broken' : '')" 
                                v-bind:title="getSyncTitle"></i>
                        </a>
                    </li>
                    <!-- TODO: implement this menu (slider) -->
                    <template v-if="!is_synced">
                        <li v-for="alocation_type in location_types" 
                            v-bind:class="{active: (alocation_type.slug == location_type.slug), scrollable: 1}">
                            <a v-on:click.prevent="onClickLocationType(alocation_type.slug)" href="#">
                                <i v-bind:class="getFAIcon(alocation_type.slug)"></i>
                                <span class="show-for-large">{{ alocation_type.label }}</span>
                            </a>
                            <template v-if="alocation_type.locations.length > 1">
                                <div class="list-filter">
                                    <input v-on:keyup.stop.prevent="filterLocations(alocation_type, $event)" type="text" name="filter" value="keyword" v-model="location_type_filters[alocation_type.slug]" placeholder="Search...">
                                    <a class="clear-filter fa fa-times-circle" href="#" v-on:click.prevent="clearLocationFilter(alocation_type)"></a>
                                </div>
                                <ul>
                                    <li v-for="alocation in alocation_type.locations"
                                        v-bind:class="{active: (alocation.slug == location.slug), 'is-submenu-item': 1, 'is-dropdown-submenu-item': 1, 'hidden': alocation.hidden}">
                                        <a v-on:click.prevent="onClickLocation(alocation.slug, alocation_type.slug)" 
                                            href="#" v-html="alocation.label_long">
                                        </a>
                                    </li>
                                </ul>
                            </template>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
        <div class="row pane-content-wrapper">
            <div class="small-12 columns">
                <div class="pane-content">
                    <!-- .pane-sidebar height is adjusted automatically with JS  -->
                    <ul v-f-dropdown class="text-center pane-sidebar vertical" 
                        data-disable-hover="true" data-click-open="true" 
                        data-alignment="right">
                        <!-- TODO: need to fix the view button. By default it should duplicate only -->
                        <!-- <li v-for="aview in views"> -->
                        <li>
                            <a href="#" v-on:click.stop.prevent="onClickViewExternal(view.slug)"
                                aria-label="Open a new panel" title="Open a new panel">
                                <i class="fa fa-columns"></i>
                            </a>
                        </li>
                        <li>
                            <a target="_blank" v-bind:href="getPrintUrl()" aria-label="Print view" title="Print view">
                                <i class="fa fa-print"></i>
                            </a>
                        </li>
                        <li v-bind:class="{toolbar: 1, hidden: display_settings.length == 0}">
                            <a><i class="fa fa-pencil"></i></a>
                            <ul class="text-left">
                                <h3>Display</h3>
                                <li v-for="setting in display_settings" v-bind:class="{active: isDisplaySettingActive(setting), 'is-submenu-item': 1, 'is-dropdown-submenu-item': 1}">
                                    <a href="#" v-on:click.stop.prevent="onClickDisplaySetting(setting)">
                                        {{ setting.label }}
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="key">
                            <a><i class="fa fa-key"></i></a>
                            <ul class="text-left">
                                <li>
                                    <h3>Notations</h3>
                                    <div v-html="conventions">
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>

                    <!-- .text-chunk height is adjusted automatically with JS  -->
                    <div class="text-chunk" v-html="chunk" v-bind:class="getClassesFromDisplaySettings()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endverbatim %}

<div class="reveal tv-reveal" id="image-viewer-modal" data-reveal>
    <h3>Image Viewer</h3>
    <div id="image-viewer"></div>
    <div class="image-viewer-caption"></div>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div class="reveal tv-reveal" id="shared-reveal" data-reveal>
    <h3>Image Viewer</h3>
    <div class="body"></div>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
{% endblock %}

{% block footer_scripts %}
    {{ block.super }}
    {# TODO: load this with require.js or webpack ? #}
    <script src="{% static 'vendor/vue/vue.js' %}"></script>
    <script src="{% static 'text_viewer/text_viewer.js' %}"></script>
{% endblock %}

{% block extra_js %}
    {# TODO: bower those leaflet scripts, externalise the custom code and move script tags to footer_scripts #}
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
        integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
        crossorigin=""></script>
    <script src="https://cdn.rawgit.com/mejackreed/Leaflet-IIIF/v1.2.1/leaflet-iiif.js"></script>
    
    <script type="text/javascript">
        $(function() {
            // Note that 256 leaves small black lines between tiles.
            var image_viewer_tile_size = 512;
            
            window.image_modal = null;
            window.image_viewer_map = null;
            window.image_viewer_map_layer = null;
             
            $('body').on('click', 'figure', function() {
                destroy_tooltip();

                if (window.image_viewer_map) {
                    window.image_viewer_map.remove();
                    window.image_viewer_map = null;
                    window.image_viewer_map_layer = null;
                }
            
                if (window.image_modal) {
                    window.image_modal.destroy();
                    window.image_modal = null;
                }
                
                var modal = window.image_modal = new Foundation.Reveal($('#image-viewer-modal'), {
                    overlay: false,
                });
                
                modal.open();
                var $modal = modal.$element;
                $modal.css('display', 'flex');
                
                var map = window.image_viewer_map = L.map('image-viewer', {
                    center: [0, 0],
                    crs: L.CRS.Simple,
                    zoom: 1,
                });
                
                var $img = $(this).find('img');
                var image_url = $img.attr('src');
                var title = $img.attr('title') || 'Image Viewer';
                var caption = $(this).find('figcaption').html() || '';
                // caption = "The temple lies in the center of a vast sanctuary, whose extent and complexity was revealed by excavations conducted from 2013 to 2016, on a site whose history goes back to Neolithic times, and which experienced an important phase of monumental constructions in the 1st Century CE. The temple was abandoned at the onset of the Early Middle Ages, and its structures were later reused in the fashioning of a Medieval defensive work. The temple has retained two sides of its square cella, at a height of over 20 meters, as well as vestiges of its ambulatory and side structure foundations. The temple's supposed dedication to the Roman god Janus is not based on any archaeological or historic fact, and the deity that was venerated in the temple is unknown.";
                
                $modal.find('h3').html(title);
                $modal.find('.image-viewer-caption').toggle(!!caption).html(caption);
                
                window.image_viewer_map_layer = L.tileLayer.iiif(
                    '//loris.cch.kcl.ac.uk/tvof/webroot/images/jp2/'+image_url+'/info.json', {
                        tileSize: image_viewer_tile_size,
                        setMaxBounds: true,
                    }
                ).addTo(map);
                
            });
            
            
            // Returns [xmin,ymin,xmax,ymax]
            // e.g, "19,26,42,42"
            // They represent the coordinates of the currently selected view
            // in the image viewer. Those coordinates are proportional
            // to the image size (in pc)
            /*
            window.image_viewer_map.getBounds()
T {_southWest: M, _northEast: M}
_northEast
:
M {lat: -187.64285278320312, lng: 204.98214721679688}
_southWest
:
M {lat: -301.2678527832031, lng: 92.23214721679688}
__proto__
:
Object

    window.get_relative_view_bounds()
"19,26,42,41"
window.set_relative_view_bounds("19,26,42,41")
            */
            function get_relative_view_bounds() {
                // Don't use this as bounds scale with zoom level!
                // var pbs = window.image_viewer_map.getPixelBounds();
                var bs = window.image_viewer_map.getBounds();
                var width = window.image_viewer_map_layer.x;
                var height = window.image_viewer_map_layer.y;
                ret = [
                    window.image_viewer_map.project(bs.getNorthWest()),
                    window.image_viewer_map.project(bs.getSouthEast()),
                ];
                var ret = [
                    '',
                    ret[0].x / width,
                    ret[0].y / height,
                    ret[1].x / width,
                    ret[1].y / height,
                ];
                ret = ret.reduce(function(str, abs) {
                    return (str ? str + ',' : '')+Math.round(abs*100);
                });
                
                return ret;
            }
            
            // opposite of get_ function, it takes something like
            // "19,26,42,42"
            // and returns LatLong bounds
            function set_relative_view_bounds(bounds_string) {
                var width = window.image_viewer_map_layer.x;
                var height = window.image_viewer_map_layer.y;
                var pcs = bounds_string.split(',');
                var vs = pcs.map(function(rel, idx) {
                    return Math.round(parseInt(rel)/100.0*[width, height][idx % 2]);
                });
                var ret = L.latLngBounds(
                    window.image_viewer_map.unproject([vs[0], vs[3]]),
                    window.image_viewer_map.unproject([vs[2], vs[1]]),
                );
                window.image_viewer_map.fitBounds(ret);
                return ret;
            }
            
            window.get_relative_view_bounds = get_relative_view_bounds;
            window.set_relative_view_bounds = set_relative_view_bounds;
            
            // note type="gloss"
            // .tei-note.tei-type-gloss > .note-text
            // See Dropbox 15_conversion of XML for the TExt viewer.docx 
            var short_hands = {
                'S':  'copiste',
                'E':  'rédacteur médiéval',
                'CE': 'rédacteur médiéval en cursive',
                'R':  'rubricateur',
                'D':  'annotateur D',
                'LH': 'annotateur catalan?',
                'LH2': 'annotateur X',
                'U':  'inconnu',
                '':   'indeterminée',
            };
            
            function get_hand_label(hand_acronym) {
                var ret = '';
                ret = short_hands[hand_acronym || ''] || hand_acronym;
                return ret;
            }
            

            // TOOLTIPS
            // unclear
            window.tv_tooltip = null;
            
            function destroy_tooltip() {
                if (window.tv_tooltip) {
                    window.tv_tooltip.destroy();
                    window.tv_tooltip = null;
                }
            }
            
            function attach_tooltip(anchors, tooltip_fields_fct) {
                $('body').on('mouseenter mouseleave', anchors, function(ev) {
                    destroy_tooltip();
                    if (ev.type == 'mouseenter') {
                        var tootlip_fields = tooltip_fields_fct($(this));
                        
                        var content = '';
                        content = '<h3>'+tootlip_fields.title+'</h3>';
                        content += '<div class="body">'+tootlip_fields.body+'</div>';
                    
                        window.tv_tooltip = new Foundation.Tooltip($(this), {
                            tipText: content, 
                            triggerClass: 'has-tip-tv',
                            tooltipClass: 'tooltip tv-tooltip',
                            positionClass: 'top',
                            allowHtml: true,
                        });
                        window.tv_tooltip.show();
                    }
                    return false;
                });
            };

            jQuery.expr[':'].notchildof = function(a,i,m){
                return jQuery(a).parents(m[3]).length < 1;
            };

            
            attach_tooltip('figure', function($el) {
                return {
                    'title': 'Image (click to view)',
                    'body': $el.find('img').attr('title'),
                }; 
            });
            attach_tooltip('.tv-view-semi-diplomatic .tei-pc-rend-6', function() {
                return {
                    'title': 'Deux barres obliques',
                    'body': 'probablement pour designer la position d’un pied-de-mouche',
                }; 
            });
            attach_tooltip('.tei-unclear', function() {
                return {
                    'title': 'Texte illisible',
                }; 
            });
            attach_tooltip('.tei-corr', function($el) { 
                return {
                    'title': 'Correction',
                    'body': 'ms. ' + $el.attr('data-sic'),
                }; 
            });
            attach_tooltip('.tei-add:notchildof(".tei-mod")', function($el) { 
                return {
                    'title': 'Addition',
                    'body': 'Main: ' + get_hand_label($el.data('tei-hand')),
                }; 
            });
            attach_tooltip('.tv-view-semi-diplomatic .tei-mod', function($el) { 
                return {
                    'title': 'Modification',
                    'body': 
                        'Contenu originel: ' + 
                        $el.find('.tei-del').html() +
                        '<br/>Main: ' + 
                        get_hand_label($el.data('tei-hand')),
                }; 
            });
            attach_tooltip('.tei-note.tei-type-gloss', function($el) {
                return {
                    'title': 'Note de lecteur médiéval',
                    'body': $el.find('.note-text').html() + '<br>' 
                            + 'Main: ' + get_hand_label($el.data('tei-resp')),
                }; 
            });

            var reveal = null;
            $('body').on('click', '.tei-note.tei-type-note', function(ev) {
                if (reveal) {
                    reveal.close();
                }
                if (ev.type == 'click') {
                    $reveal = $('#shared-reveal');
                    $reveal.find('.body').html($(this).find('.note-text').html());
                    
                    var subtype_to_title = {
                        'source': 'Sources',
                        'trad':   'Tradition',
                        'gen':    'Note',
                        '':       'Note',
                    };
                    $reveal.find('h3').html(subtype_to_title[$(this).data('tei-subtype')] || 'Note');
                    if (!reveal) {
                        reveal = new Foundation.Reveal($reveal, {
                            overlay: false,
                        });
                    }
                    reveal.open();
                }
                return false;
            });
            
        })
    </script>
{% endblock %}
