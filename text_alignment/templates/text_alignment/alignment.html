{% extends "base_minimal.html" %}
{% load staticfiles compress require cms_tags wagtailcore_tags %}

{% block extra_head %}
<style>
    .alignment-paras {
        border-spacing: 0px;
    }
    .alignment-paras td, .alignment-paras th {
        border: 0px;
        border-left: 1px solid grey;
        border-bottom: 1px solid grey;
    }
    .alignment-paras thead tr {
        background-color: white;
    }
    .fixed-tr {
        position: absolute;
        display: none;
    }
    .para-ms-absent {
        background-color: darkgrey;
    }
    .para-ms-verse {
        background-color: lightblue;
    }
</style>
{% endblock %}

{% block title %}
Alignment
{% endblock %}

{% block body_classes %}body-alignment{% endblock %}

{% block header_top_bar %}
    <ul class="horizontal menu float-right mini-header">
        {% comment %}
        <li>
            <a href=""><i class="fa fa-key"></i></a>
        </li>
        {% endcomment %}
        {% comment %}
        <li>
            <a href=""><i class="fa fa-random"></i></a>
        </li>
        <li>
            {# <a href=""><i class="fa fa-columns"></i></a> #}
    
            <a id="btn-open-panel" href="#" title="Open a new panel">
                <i class="fa fa-columns"></i>
            </a>
        </li>
        <li>
            <a href=""><i class="fa fa-expand"></i></a>
        </li>
        {% endcomment %}
    </ul>
{% endblock %}

{% block minimal_breadcrumb %}
    <small>/ Alignment</small>
{% endblock %}

{% block main_wrapper %}

<!-- #text-viewer height is adjusted automatically with JS  -->
<section id="alignment-fragment" class="main">
    
</section>

{% endblock %}

{% block footer_scripts %}
    {{ block.super }}
    {# TODO: load this with require.js or webpack ? #}
    <script src="{% static 'vendor/vue/vue.js' %}"></script>
    <script src="{% static 'text_alignment/alignment.js' %}"></script>
{% endblock %}

{% block extra_js %}
    {# TODO: bower those leaflet scripts, externalise the custom code and move script tags to footer_scripts #}
    
    <script type="text/javascript">
        $(function() {
            var $win = $(window);
            
            function request_fragment() {
                var url = document.location.href;
                url += (url.indexOf('?') > -1) ? '&' : '?;';
                url += 'js=1'
                var req = $.getJSON({
                    url: url
                })
                req.done(function(data, textStatus, jqXHR) {
                    replace_fragment(data);
                });
            }
            request_fragment();
            
            function replace_fragment(data) {
                $('#alignment-fragment').html(data.html);
                fix_thead();
            }
            
            var row_top = 0;
            function fix_width_row($row) {
                $row.children().each(function(index, th) {
                    $th = $(th);
                    $th.css('min-width', $th.outerWidth());
                });
            }
            function fix_thead() {
                $('.fixed-tr').remove();
                
                $row = $('.alignment-paras thead tr:first');
                
                if ($row.length == 0) return;
                
                fix_width_row($row);
                
                $row_fixed = $row.clone();
                $row.parent().append($row_fixed);
                
                $row_fixed.addClass('fixed-tr');
                
                $row_fixed.data('threshold', $row.offset().top);
            }

            $win.on('scroll', function() {
                var top = $win.scrollTop();
                $('.fixed-tr').each(function(index, row) {
                    var $row = $(row);
                    $row.toggle(top > $(row).data('threshold')).css('top', top);
                });
            });
        });
    </script>
{% endblock %}
